name: Publish

on:
  release:
    types:
      - published

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2
    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        distribution: 'zulu'
        java-version: 17
    - name: Caching
      uses: actions/cache@v2
      with:
        path: |
          ~/.brachyura/cache
          .brachyura
          buildscript/build
        key: ${{ runner.os }}-brachyura-${{ hashFiles('**/Buildscript.java') }}
        restore-keys: z${{ runner.os }}-brachyura
    - name: Build with Brachyura
      run: java -jar brachyura-bootstrap-0.jar build -j 2
    - name: Create changelog
      uses: fregante/release-with-changelog@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        exclude: '/dependencies|dependency|bump|^v?\d+\.\d+\.\d+/i'
        prerelease: true
        commit-template: '- {date}: {hash} {title} {url}'
        template: |
          ### Changelog

          {commits}

          {range}
        title: Beta {tag}
    - name: Upload release assets
      uses: AButler/upload-release-assets@v2.0
      with:
          files: 'build/libs/*'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
